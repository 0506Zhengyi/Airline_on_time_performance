--- 
title: "Airline On Time Performance"
author: "Ziyu Song, Zhengyi Fang"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction


What is the most common reason for flight cancellation? What could I be delayed by? Which airline has the most delays? These are the problems that have been bothering travelers every time when they have a business trip, holiday travel, or studying abroad. Nowadays, flight delays and cancellations are tricky problems for travelers. In the U.S., there are lots of choices of airlines, airports, and carriers every day in most of the areas. In order to help people better understand the past performance of airlines and plan for their future trips, our group decided to apply advanced data visualization and analytics techniques to a large amount of real airline on-time data from Data Expo. In this project, we are going to provide the observations and insights from our data visuaization results to discuss the questions we are interested in and provide constructive suggestions.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources


Data sources: [Data Expo 2009 - Airline on-time performance](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/HG7NV7)

The dataset, Data Expo 2009: Airline on-time data, consists of flight arrival, departure, and cancellation details for all commercial flights within the USA from 1987 to 2008. In this project, we will analyze the data of the first 4 months of 2008. The dataset is real and provides complementary information to answer the questions that we are interested in. Analyzing this dataset to discuss flight delay and cancellation-related topics can help travelers choose better travel routes in the future. On the other hand, the dataset includes some null/blanks and different kinds of data types, such as integers and floats, so it is a good practice for us to perform the data cleaning, analysis, and visualization.

In our group, both members are responsible for collecting the data from the original source. Zhengyi Fang is also responsible for extracting the data that we want to analyze from the entire dataset.

There are 2,389,217 records and 29 variables in our final dataset. The dataset variable descriptions and types of variables are listed below:
https://github.com/zs2488/Airline_on_time_performance/blob/main/II.Dataset%20Variables.png

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

```{r, include=FALSE}
library(tidyverse)
```

```{r, include=FALSE}
df <- read.csv("C:/Users/20961/Desktop/2008.csv")
```

```{r, include=FALSE}
unique(df$CancellationCode)
```

```{r, include=FALSE}
#change blank cell to NA
df <- df %>% 
  mutate_all(na_if,"")
```

```{r, include=FALSE}
class(df$DepTime)
df <- df %>%
  mutate(DepHour = floor(df$DepTime/100),
         ArrHour = floor(df$DepTime/100))
```

```{r, include=FALSE}
df <- df %>%
  mutate(Origin_state = case_when(
    Origin == "BHM"|Origin == "DHM"|Origin == "HSV"|Origin == "MOB"|Origin == "MGM" ~ "AL",
    
    Origin == "ANC"|Origin == "FAI"|Origin == "JNU" ~ "AK",
    
    Origin == "FLG"|Origin == "PHX"|Origin == "TUS"|Origin == "YUM" ~ "AZ",
    
    Origin == "FYV"|Origin == "LIT" ~ "AR",
    
    Origin == "BUR"|Origin == "FAT"|Origin == "LGB"|Origin == "LAX"|Origin == "OAK"|Origin == "ONT"|Origin == "PSP"|Origin == "SMF"|Origin == "SAN"|Origin == "SFO"|Origin == "SJC"|Origin == "SNA" ~ "CA",
    
    Origin == "ASE"|Origin == "COS"|Origin == "DEN"|Origin == "GJT"|Origin == "PUB" ~ "CO",
    
    Origin == "BDL" ~ "CT",
    
    Origin == "IAD"|Origin == "DCA" ~ "DC",
    
    Origin == "DAB"|Origin == "FLL"|Origin == "RSW"|Origin == "JAX"|Origin == "MIA"|Origin == "MCO"|Origin == "PNS"|Origin == "PIE"|Origin == "SRQ"|Origin == "TPA"|Origin == "PBI"|Origin == "PFN" ~ "FL",
    
    Origin == "ATL"|Origin == "AGS"|Origin == "SAV" ~ "GA",
    
    Origin == "ITO"|Origin == "HNL"|Origin == "OGG"|Origin == "KOA"|Origin == "LIH" ~ "HI",
    
    Origin == "BOI" ~ "ID",
    
    Origin == "MDW"|Origin == "ORD"|Origin == "MLI"|Origin == "PIA" ~ "IL",
    
    Origin == "EVV"|Origin == "FWA"|Origin == "IND"|Origin == "SBN" ~ "IN",
    
    Origin == "CID"|Origin == "DSM" ~ "IA",
    
    Origin == "ICT" ~ "KS",
    
    Origin == "LEX"|Origin == "SDF" ~ "KY",
    
    Origin == "BTR"|Origin == "MSY"|Origin == "SHV" ~ "LA",
    
    Origin == "AUG"|Origin == "BGR"|Origin == "PWM" ~ "ME",
    
    Origin == "BWI" ~ "MD",
    
    Origin == "BOS"|Origin == "HYA"|Origin == "ACK"|Origin == "ORH" ~ "MA",
    
    Origin == "BTL"|Origin == "DTW"|Origin == "DET"|Origin == "FNT"|Origin == "GRR"|Origin == "AZO"|Origin == "LAN"|Origin == "MBS" ~ "MI",
    
    Origin == "DLH"|Origin == "MSP"|Origin == "RST" ~ "MN",
    
    Origin == "GPT"|Origin == "JAN" ~ "MS",
    
    Origin == "MCI"|Origin == "STL"|Origin == "SGF" ~ "MO",
    
    Origin == "BIL" ~ "MT",
    
    Origin == "LNK"|Origin == "OMA" ~ "NE",
    
    Origin == "LAS"|Origin == "RNO" ~ "NV",
    
    Origin == "MHT" ~ "NH",
    
    Origin == "ACY"|Origin == "EWR"|Origin == "TTN" ~ "NJ",
    
    Origin == "ABQ"|Origin == "ALM" ~ "NM",
    
    Origin == "ALB"|Origin == "BUF"|Origin == "ISP"|Origin == "JFK"|Origin == "LGA"|Origin == "SWF"|Origin == "ROC"|Origin == "SYR"|Origin == "HPN" ~ "NY",
    
    Origin == "AVL"|Origin == "CLT"|Origin == "FAY"|Origin == "GSO"|Origin == "RDU"|Origin == "INT" ~ "NC",
    
    Origin == "BIS"|Origin == "FAR" ~ "ND",
    
    Origin == "CAK"|Origin == "CVG"|Origin == "CLE"|Origin == "CMH"|Origin == "DAY"|Origin == "TOL" ~ "OH",
    
    Origin == "OKC"|Origin == "TUL" ~ "OK",
    
    Origin == "EUG"|Origin == "PDX"|Origin == "HIO"|Origin == "SLE" ~ "OR",
    
    Origin == "ABE"|Origin == "ERI"|Origin == "MDT"|Origin == "PHL"|Origin == "PIT"|Origin == "AVP" ~ "PA",
    
    Origin == "PVD" ~ "RI",
    
    Origin == "CHS"|Origin == "CAE"|Origin == "GSP"|Origin == "MYR" ~ "SC",
    
    Origin == "PIR"|Origin == "RAP"|Origin == "FSD" ~ "SD",
    
    Origin == "TRI"|Origin == "CHA"|Origin == "TYS"|Origin == "MEM"|Origin == "BNA" ~ "TN",
    
    Origin == "AMA"|Origin == "AUS"|Origin == "CRP"|Origin == "DAL"|Origin == "DFW"|Origin == "ELP"|Origin == "HOU"|Origin == "IAH"|Origin == "LBB"|Origin == "MAF"|Origin == "SAT" ~ "TX",
    
    Origin == "SLC" ~ "UT",
    
    Origin == "BTV"|Origin == "MPV"|Origin == "RUT" ~ "VT",
    
    Origin == "IAD"|Origin == "PHF"|Origin == "ORF"|Origin == "RIC"|Origin == "ROA" ~ "VA",
    
    Origin == "PSC"|Origin == "SEA"|Origin == "GEG" ~ "WA",
    
    Origin == "CRW"|Origin == "CKB" ~ "WV",
    
    Origin == "GRB"|Origin == "MSM"|Origin == "MKE" ~ "WI",
    
    Origin == "CPR"|Origin == "CYS"|Origin == "JAC"|Origin == "RKS" ~ "WY"
    ))
```

```{r, include=FALSE}
df <- df %>%
  mutate(Dest_state = case_when(
    Dest == "BHM"|Dest == "DHM"|Dest == "HSV"|Dest == "MOB"|Dest == "MGM" ~ "AL",
    
    Dest == "ANC"|Dest == "FAI"|Dest == "JNU" ~ "AK",
    
    Dest == "FLG"|Dest == "PHX"|Dest == "TUS"|Dest == "YUM" ~ "AZ",
    
    Dest == "FYV"|Dest == "LIT" ~ "AR",
    
    Dest == "BUR"|Dest == "FAT"|Dest == "LGB"|Dest == "LAX"|Dest == "OAK"|Dest == "ONT"|Dest == "PSP"|Dest == "SMF"|Dest == "SAN"|Dest == "SFO"|Dest == "SJC"|Dest == "SNA" ~ "CA",
    
    Dest == "ASE"|Dest == "COS"|Dest == "DEN"|Dest == "GJT"|Dest == "PUB" ~ "CO",
    
    Dest == "BDL" ~ "CT",
    
    Dest == "IAD"|Dest == "DCA" ~ "DC",
    
    Dest == "DAB"|Dest == "FLL"|Dest == "RSW"|Dest == "JAX"|Dest == "MIA"|Dest == "MCO"|Dest == "PNS"|Dest == "PIE"|Dest == "SRQ"|Dest == "TPA"|Dest == "PBI"|Dest == "PFN" ~ "FL",
    
    Dest == "ATL"|Dest == "AGS"|Dest == "SAV" ~ "GA",
    
    Dest == "ITO"|Dest == "HNL"|Dest == "OGG"|Dest == "KOA"|Dest == "LIH" ~ "HI",
    
    Dest == "BOI" ~ "ID",
    
    Dest == "MDW"|Dest == "ORD"|Dest == "MLI"|Dest == "PIA" ~ "IL",
    
    Dest == "EVV"|Dest == "FWA"|Dest == "IND"|Dest == "SBN" ~ "IN",
    
    Dest == "CID"|Dest == "DSM" ~ "IA",
    
    Dest == "ICT" ~ "KS",
    
    Dest == "LEX"|Dest == "SDF" ~ "KY",
    
    Dest == "BTR"|Dest == "MSY"|Dest == "SHV" ~ "LA",
    
    Dest == "AUG"|Dest == "BGR"|Dest == "PWM" ~ "ME",
    
    Dest == "BWI" ~ "MD",
    
    Dest == "BOS"|Dest == "HYA"|Dest == "ACK"|Dest == "ORH" ~ "MA",
    
    Dest == "BTL"|Dest == "DTW"|Dest == "DET"|Dest == "FNT"|Dest == "GRR"|Dest == "AZO"|Dest == "LAN"|Dest == "MBS" ~ "MI",
    
    Dest == "DLH"|Dest == "MSP"|Dest == "RST" ~ "MN",
    
    Dest == "GPT"|Dest == "JAN" ~ "MS",
    
    Dest == "MCI"|Dest == "STL"|Dest == "SGF" ~ "MO",
    
    Dest == "BIL" ~ "MT",
    
    Dest == "LNK"|Dest == "OMA" ~ "NE",
    
    Dest == "LAS"|Dest == "RNO" ~ "NV",
    
    Dest == "MHT" ~ "NH",
    
    Dest == "ACY"|Dest == "EWR"|Dest == "TTN" ~ "NJ",
    
    Dest == "ABQ"|Dest == "ALM" ~ "NM",
    
    Dest == "ALB"|Dest == "BUF"|Dest == "ISP"|Dest == "JFK"|Dest == "LGA"|Dest == "SWF"|Dest == "ROC"|Dest == "SYR"|Dest == "HPN" ~ "NY",
    
    Dest == "AVL"|Dest == "CLT"|Dest == "FAY"|Dest == "GSO"|Dest == "RDU"|Dest == "INT" ~ "NC",
    
    Dest == "BIS"|Dest == "FAR" ~ "ND",
    
    Dest == "CAK"|Dest == "CVG"|Dest == "CLE"|Dest == "CMH"|Dest == "DAY"|Dest == "TOL" ~ "OH",
    
    Dest == "OKC"|Dest == "TUL" ~ "OK",
    
    Dest == "EUG"|Dest == "PDX"|Dest == "HIO"|Dest == "SLE" ~ "OR",
    
    Dest == "ABE"|Dest == "ERI"|Dest == "MDT"|Dest == "PHL"|Dest == "PIT"|Dest == "AVP" ~ "PA",
    
    Dest == "PVD" ~ "RI",
    
    Dest == "CHS"|Dest == "CAE"|Dest == "GSP"|Dest == "MYR" ~ "SC",
    
    Dest == "PIR"|Dest == "RAP"|Dest == "FSD" ~ "SD",
    
    Dest == "TRI"|Dest == "CHA"|Dest == "TYS"|Dest == "MEM"|Dest == "BNA" ~ "TN",
    
    Dest == "AMA"|Dest == "AUS"|Dest == "CRP"|Dest == "DAL"|Dest == "DFW"|Dest == "ELP"|Dest == "HOU"|Dest == "IAH"|Dest == "LBB"|Dest == "MAF"|Dest == "SAT" ~ "TX",
    
    Dest == "SLC" ~ "UT",
    
    Dest == "BTV"|Dest == "MPV"|Dest == "RUT" ~ "VT",
    
    Dest == "IAD"|Dest == "PHF"|Dest == "ORF"|Dest == "RIC"|Dest == "ROA" ~ "VA",
    
    Dest == "PSC"|Dest == "SEA"|Dest == "GEG" ~ "WA",
    
    Dest == "CRW"|Dest == "CKB" ~ "WV",
    
    Dest == "GRB"|Dest == "MSM"|Dest == "MKE" ~ "WI",
    
    Dest == "CPR"|Dest == "CYS"|Dest == "JAC"|Dest == "RKS" ~ "WY"
  ))
```

```{r,include=FALSE}
write.csv(df,"C:/Users/20961/Desktop/transformed_2008.csv", row.names = FALSE)
```


We did the following transformations to make this dataset to be ready for data analysis and visualization.

* **Convert blank cell to NA**

There are some blank cells in the original dataset. Changing it to NA will give us better insights regarding missing values.

* **Extract departure hour and arrival hour from DeptTime and ArrTime**

For two variables Deptime and ArrTime (stored as integer), we extract their first one or two digits by dividing the number by 100 and rounding down to an integer. Then, we had two new variables stand for departure hour and arrival hour respectively. The purpose is to analyze the relationship between hour time and cancellation/ delay in the following chapters.

* **Add origin state and destination state**

Since we want to consider geographical location and pursue is there any states in America that have more flight cancellations than others, we need the information of departure and arrival state. Unfortunately, this information is not contained in the original dataset. What we have is the original and destination airport. According to the [airport code and its corresponding state](http://static.samaritanspurse.org.s3.amazonaws.com/public/OHOP/US-Airport-Codes.pdf) available online, we added two new variables to include state information into our dataset.

The transformed dataset is presented below.
```{r}
print(head(df, 5))
```


<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r, include=FALSE}
library(tidyverse)
library(patchwork)
library(janitor)
library(ggpubr)
library(egg)
```

```{r, include=FALSE}
plot_missing_pattern = function(mycars, show_percentage=FALSE){
# a tibble with each row: <var> <missing_count>, sorted desc
  if (show_percentage) {
    missing_patterns_by_column <- mycars %>%
      summarise_all(list(~ sum(is.na(.))/dim(mycars)[1])) %>%
      pivot_longer(names(mycars)) %>%
      arrange(desc(value))
    STRING1 = "% rows"
    
  } else {
    missing_patterns_by_column <- mycars %>%
      summarise_all(list(~ sum(is.na(.)))) %>%
      pivot_longer(names(mycars)) %>%
      arrange(desc(value))
    STRING1 = "num rows missing:"
  }

# save a copy of descend column names for future use
descend_column_names <- missing_patterns_by_column$name

column_missing_bar_chart <- ggplot(
  missing_patterns_by_column,
  aes(x=factor(name, levels=descend_column_names), y=value))+
  geom_bar(stat='identity', fill='#86A6EF') +
  ylab(STRING1) + xlab('') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

# the starting code, grouped by column, count missing, and add a total column
missing_patterns <- data.frame(is.na(mycars)) %>%
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup()

# find out the row with all FALSEs
missing_patterns_plot <- missing_patterns %>% mutate_all((as.integer)) %>% mutate(
  num.of.missing = rowSums(.[1:dim(mycars)[2]]), id=row.names(.)) %>%
  mutate(alpha=ifelse(num.of.missing==0, 1, 0.5))
complete_row <- missing_patterns_plot  %>% filter(num.of.missing == 0) %>% select(id) %>% as.character()

order_level <- sort(as.numeric(unique(missing_patterns_plot$id)))
missing_patterns_plot$id <- factor(missing_patterns_plot$id, levels = order_level)

row_missing_bar_chart <- missing_patterns_plot %>%
  ggplot(aes(y=fct_rev(id), x=count)) +
  geom_bar(stat='identity', fill='#86A6EF', aes(alpha=factor(alpha))) +
  xlab(STRING1) + ylab('') +
  theme(legend.position = "none") + 
  scale_alpha_manual(values = c("0.5"=0.5, "1"=1),guide="none") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


main_plot_df <- data.frame(is.na(mycars)) %>%
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup() %>%
  rownames_to_column("id") %>%
  select(-count) %>%
  gather(key, value, -id) %>%
  mutate(id = as.factor(id), missing = ifelse(value=="TRUE", "1","0"), key = factor(key, levels = c(descend_column_names)))

order_level <- sort(as.numeric(unique(main_plot_df$id)))
main_plot_df$id <- factor(main_plot_df$id, levels = order_level)

main_plot <- ggplot(main_plot_df) + geom_tile(aes(x = key, y = fct_rev(id), fill=missing), color = "white") + 
  scale_fill_manual(values=c("1"="#A689E0", "0"="white")) +
  annotate(geom="text", x=descend_column_names[round(dim(mycars)[2]/2)], y=complete_row, label="complete cases") +
  theme(legend.position="none") +
  xlab("variable") +
  ylab("Missing pattern") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


# a pure ggplot2 with white background
null.plot <- ggplot() + theme_minimal()
ggarrange(
  column_missing_bar_chart,
  null.plot,
  main_plot,
  row_missing_bar_chart,
  ncol=2,nrow=2,widths = c(20,5),heights=c(4,10),
  top="Missing value patterns"
)
}
```

```{r, include=FALSE}
df <- read.csv("C:/Users/20961/Desktop/2008.csv")
```

```{r}
plot_missing_pattern(df)
```

(draft)

Based on the plot presented above, the columns/features CarrierDelay, WeatherDelay, NASDelay, SecurityDelay, and LateAircraftDelay have the most number of rows in missing value. They describe a delay in minutes due to a specific reason. For example, WeatherDelay equals 5 means the delay caused by extreme weather conditions is 5 minutes. These five features have missing values above 1500000 rows. In addition, the other 8 features including ArrTime (actual arrival time), ActualElapsedTime, AirTime, etc. also have some missing values but less than 100000 rows.

There are six missing patterns in our dataset and the most common one (more than 1500000 rows) is missing CarrierDelay, WeatherDelay, NASDelay, SecurityDelay, and LateAircraftDelay altogether. This pattern is most common maybe there is no delay in most flights or the reason is unknown. The pattern ranked second is complete cases. The third pattern is missing all of the features in the first pattern plus ArrTime, ActualElapsedTime, AirTime, ArrDelay, Taxiln, DepTime, DepDelay, and TaxiOut. This may be caused by the cancellation. Thus, we have no information regarding the delay, departure, arrival, etc. The other three patterns share most features with pattern 3 but there are slight differences. Since the number of missing values is much fewer than the first three, we will not discuss them in detail.

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

```{r, include=FALSE}
#load packages
library(data.table)
library(dplyr)
library(lubridate)
library(scales)
library(ggplot2)
library(RColorBrewer)
library(tidyverse)
library(readr)
library(maps)
library(mapdata)
library(usdata)
library(ggridges)
library(Hmisc)
library(ggpubr)
library(stats)
library(patchwork)
library(GGally)
```

```{r, include=FALSE}
df <- read.csv("C:/Users/20961/Desktop/transformed_2008.csv")
```

* Graph1: Most common reason for flight cancellation

**A=Carrier Caused, B=Weather, C=National Aviation System, D=Security**
```{r, include=FALSE}
#Q1 What is the most common reason for flight cancellation?
#A-Carrier Caused
#B-Weather
#C-National Aviation System
#D-Security
#https://aspm.faa.gov/aspmhelp/index/ASPM_Data_Download__Definitions_of_Variables.html
cancel_origin <- df %>%
  select(Origin_state, CancellationCode) %>%
  na.omit %>%
  group_by(Origin_state,CancellationCode) %>%
  mutate(n_cancel = n()) %>%
  unique()

cancel_origin2 <- cancel_origin %>%
  group_by(Origin_state) %>%
  mutate(total_cancel = sum(n_cancel)) %>%
  select(Origin_state, total_cancel) %>%
  unique() %>%
  arrange(desc(total_cancel))

cancel_origin2 <- cancel_origin2[1:10,]
```

```{r, include=FALSE}
unique(df$CancellationCode)
```

```{r,fig.height=6}
plot11 <- df %>% 
  filter(!is.na(CancellationCode)) %>%
  ggplot(aes(x = CancellationCode,na.rm = TRUE))+
  geom_bar(fill = "cornflowerblue")+
  xlab("Reason for Cancellation")+
  ylab("Count")+
  ggtitle("Number of Cancellation by Reason")+
  theme(plot.title = element_text(size = 10))
  #scale_x_discrete(labels=c("Carrier Caused", "Weather","National Aviation System","Security"))

plot12 <- df %>% 
  filter(!is.na(CancellationCode)) %>%
  ggplot(aes(x = CancellationCode,na.rm = TRUE))+
  geom_bar()+
  xlab("Reason for Cancellation")+
  ylab("Count")+
  #scale_x_discrete(labels=c("Carrier Caused", "Weather","National Aviation System","Security"))+
  facet_wrap(~UniqueCarrier)+
  ggtitle("Number of Cancellation by Reason Faceted by Carrier")+
  theme(plot.title = element_text(size = 12))

plot13 <- cancel_origin2 %>%
  ggplot()+
  geom_bar(mapping = aes(x = reorder(Origin_state,-total_cancel), y = total_cancel), stat = "identity", fill = "lightblue")+
  xlab("Origin State")+
  ylab("Count")+
  ggtitle("Top 10 States Occrued Cancellation Most")+
  theme(plot.title = element_text(size = 10))

ggarrange(ggarrange(plot11, plot13, ncol = 2), plot12, nrow = 2,
          heights = c(3,7)) 
```

```{r, include=FALSE}
#test
test <- df[,c("Origin_state","CancellationCode")]
test <- test[!is.na(test$CancellationCode),]
test <- na.omit(test)
nrow(test[test$Origin_state == "CA",])
```

* Graph2: Cancellation rate vs. number
```{r, include=FALSE}
#filter and transform data
df2 <- df %>%
  select("UniqueCarrier","CancellationCode") %>%
  group_by(UniqueCarrier) %>%
  mutate(total_flight = n())

df22 <- df2 %>%
  na.omit() %>%
  select("UniqueCarrier","CancellationCode") %>%
  group_by(UniqueCarrier,CancellationCode) %>%
  mutate(n_cancel = n()) %>%
  unique() %>%
  arrange(UniqueCarrier,CancellationCode)

df23 <- df22 %>%
  group_by(UniqueCarrier) %>%
  mutate(total_cancel = sum(n_cancel))

df2 <- df2 %>%
  select("UniqueCarrier","total_flight") %>%
  unique()

df24 <- merge(df23,df2,by="UniqueCarrier",all.x = TRUE)
df24 <- df24 %>%
  mutate(cancel_rate = total_cancel/total_flight)

getPalette = colorRampPalette(brewer.pal(4, "Purples"))
```

```{r, fig.height=4}
ggplot(df24, aes(fill=fct_rev(CancellationCode), y=n_cancel, x=reorder(UniqueCarrier,-total_cancel))) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values=getPalette(5))+
  geom_line(aes(x=reorder(UniqueCarrier,-total_cancel), y = 100000*cancel_rate), size = 1, color="red", group = 1) + 
  scale_y_continuous(sec.axis = sec_axis(~./100000, name = "Cancellation Rate"))+
  xlab("Carrier")+
  ylab("Number of Cancellation")+
  labs(fill = "Cancellation Code")
```

* Graph3: Number of delay and average delay (in mins)
```{r, include=FALSE}
#delay
delay <- df %>%
  select(c("DepDelay","CarrierDelay","WeatherDelay","NASDelay","SecurityDelay","LateAircraftDelay"))

delay <- delay[delay$DepDelay > 0,]

delay2 <- delay %>% na.omit()
dc <- nrow(delay2[delay2$CarrierDelay > 0,])
dw <- nrow(delay2[delay2$WeatherDelay > 0,])
dn <- nrow(delay2[delay2$NASDelay > 0,])
ds <- nrow(delay2[delay2$SecurityDelay > 0,])
dl <- nrow(delay2[delay2$LateAircraftDelay > 0,])

c1 <- c("CarrierDelay","WeatherDelay","NASDelay","SecurityDelay","LateAircraftDelay")

c2 <- c(dc,dw,dn,ds,dl)

delay_count <- data.frame("reason" = c1, "count" = c2, stringsAsFactors = FALSE)
```

```{r, include=FALSE}
df31 <- df[,c1] %>%
  na.omit() 
df32 <- df31 %>%
  mutate(id = row_number()) %>%
  pivot_longer(!id, names_to = "reason", values_to = "delay_min") %>%
  select("reason","delay_min") %>%
  arrange(reason)

df32 <- df32[df32$delay_min != 0,]

df33 <- df32 %>%
  group_by(reason) %>%
  mutate(avg_delay = mean(delay_min)) %>%
  select("reason","avg_delay") %>%
  unique()

getPalette2 = colorRampPalette(brewer.pal(5, "GnBu"))
```

```{r, fig.height=7.5}
#barchart: number of delay
plot31 <- delay_count %>%
  ggplot()+
  geom_bar(mapping = aes(x = reorder(reason,-count), y = count,fill = reason), stat = "identity")+
  xlab("Reason for Delay")+
  ylab("Count")+
  scale_fill_manual(values=getPalette2(5))+
  theme(legend.position = "None",
        axis.text.x = element_text(size=6))

#barchart: average delay (mins)
plot32 <- df33 %>% ggplot()+
  geom_bar(mapping = aes(x = reorder(reason,-avg_delay), y = avg_delay, fill = reason), stat = "identity")+
  xlab("Reason for Delay")+
  ylab("Average Delay (mins)")+
  scale_fill_manual(values=getPalette2(5))+
  theme(legend.title = element_blank(),legend.position = "top",
        axis.text.x = element_text(size=6))

legend <- get_legend(plot32)

plot32_ <- plot32 + theme(legend.position = "None")

#boxplot: delay reason vs delay mins
#explore median, outliers
plot33 <- ggplot(df32, aes(x=reason, y=delay_min)) + 
    geom_boxplot(notch=TRUE,notchwidth = 0.8,
        outlier.colour="red",outlier.size = 2,outlier.shape = 1)+
  xlab("Reason for Delay")+
  ylab("Delay (mins)")

#redgeplot: delay reason vs. delay mins
#explore distribution
plot34 <- df32[df32$delay_min <= 200,]%>%
  ggplot(aes(delay_min, fct_reorder(reason, delay_min,median))) + 
  geom_density_ridges(fill = "cornflowerblue", alpha = .3,scale = 1)+
  labs(x = "Delay (mins)",
       y = "Reason for Delay",
       caption = "Select delay less than 200 mintues")

ggarrange(ggarrange(legend, ggarrange(plot31, plot32_, ncol = 2, nrow = 1),ncol = 1,nrow = 2,heights = c(2,10)),plot33,plot34,
          ncol = 1, nrow = 3)
```

(draft)
The most common reason for flight cancellation is carrier caused, and the weather ranked second. There is not too much difference between the first two. Intuitively, we can avoid cancellation by selecting top carriers or flying in nice weather conditions. In addition, the national aviation system also counts for a part of cancellation but it is only a half of the weather. Security ranked last and there are only 6 flights canceled due to security out of 2389217 flights.

In contrast, the top 3 reasons for flight delay are the national aviation system, late-arriving aircraft, and carrier caused, which is quite different from cancellation. It is less likely to avoid delay in advance since the top two reasons are not predictable and controllable. However, we can avoid delays by choosing carriers to some extent.

* Graph4: Explore carrier that occure delay most
```{r, include=FALSE}
#Top 10 carrier which occur delays most

#airline/carrier
#Top 10 airlines measured by average delay
carrier1 <- df %>%
  select(c('UniqueCarrier','DepDelay'))%>%
  group_by(UniqueCarrier) %>%
  mutate(avg_delay = round(mean(DepDelay, na.rm = TRUE),digits = 2)) %>%
  select(c('UniqueCarrier','avg_delay')) %>%
  unique() %>%
  arrange(desc(avg_delay))
```

```{r, include=FALSE}
#airline/carrier
#Top 10 airlines measured by percentage of delayed flights
car_del <- df %>%
  select(c('UniqueCarrier', 'DepDelay')) %>%
  mutate(DelayOrNot = case_when(
    DepDelay > 0 ~ 1,
    DepDelay <= 0 ~ 0
  ))

pct_delayed <- car_del %>%
  group_by(UniqueCarrier) %>%
  na.omit() %>%
  mutate(total_flight = n(), total_delayed = sum(DelayOrNot)) %>%
  select(c('UniqueCarrier','total_flight','total_delayed')) %>%
  unique() %>%
  mutate(pct = total_delayed/total_flight) %>%
  arrange(desc(pct))

df41 <- merge(carrier1,pct_delayed, by="UniqueCarrier",all.x = TRUE)
df41 <- df41 %>%
  mutate(judge = case_when(
    avg_delay > 0 ~ TRUE,
    avg_delay < 0 ~ FALSE
  ))
```

```{r, include=FALSE}
#tmp3 -> df42
df42 <- df %>%
  select(c('UniqueCarrier','CarrierDelay','WeatherDelay','NASDelay','SecurityDelay','LateAircraftDelay')) %>%
  na.omit() %>%
  mutate(carrier = case_when(
    CarrierDelay > 0 ~ 1,
    CarrierDelay <= 0 ~ 0
  ), weather = case_when(
    WeatherDelay > 0 ~ 1,
    WeatherDelay <= 0 ~ 0
  ), nas = case_when(
    NASDelay > 0 ~ 1,
    NASDelay <= 0 ~ 0
  ), security = case_when(
    SecurityDelay > 0 ~ 1,
    SecurityDelay <= 0 ~ 0
  ), late = case_when(
    LateAircraftDelay > 0 ~ 1,
    LateAircraftDelay <= 0 ~ 0
  ))

df42 <- df42 %>%
  select(c('UniqueCarrier','carrier','weather','nas','security','late'))

df42 <- df42 %>%
  group_by(UniqueCarrier) %>%
  mutate(total_carrier = sum(carrier),
         total_weather = sum(weather),
         total_nas = sum(nas),
         total_security = sum(security),
         total_late = sum(late)) %>%
  select(c('UniqueCarrier','total_carrier','total_weather','total_nas','total_security','total_late')) %>%
  unique()

df42$total = rowSums(df42[-1])
df42_p <- df42[,c("UniqueCarrier","total")]

#tmp4 -> df43
df42 <- df42[-c(7)]
df43 <- df42 %>%
  pivot_longer(!UniqueCarrier, names_to = "reason", values_to = "num_delay")

#tmp5 -> df44
df44 <- merge(df43,df42_p,y.by = "UniqueCarrier")

getPalette3 = colorRampPalette(brewer.pal(6, "Set2"))
```

```{r, fig.height=3}
  ggplot(df41, aes(x = reorder(UniqueCarrier,-avg_delay), y = avg_delay, fill = judge))+
  geom_bar(stat = "identity")+
  geom_line(aes(x = reorder(UniqueCarrier,-avg_delay), y = pct*15), color = "red", size = 0.9, group = 1, alpha = 0.6)+
  geom_point(aes(x = reorder(UniqueCarrier,-avg_delay), y = pct*15), size = 1.5, group = 1, color = "red", fill = "red", alpha = 0.6)+
  scale_y_continuous(sec.axis=sec_axis(~./15,name = "Percentage of Delayed Flights"))+
  scale_fill_manual(values = c("#92c0df","#fcbe75"))+
  theme(legend.position = "None")+
  ylab("Average Delay (mins)")+
  xlab("Carrier")
```

```{r, fig.height=5}
ggplot(df44, aes(fill=fct_rev(reason), y=num_delay, x=reorder(UniqueCarrier,total))) + 
    geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values=getPalette3(5))+
  xlab("Airline")+
  ylab("Total Number of Delay")+
  coord_flip()
```

* Graph5
```{r, include=FALSE}
all_states <- map_data("state")

delay_state <- df %>%
  select(c("Origin_state","DepDelay"))%>%
  group_by(Origin_state) %>%
  mutate(delay = round(mean(DepDelay, na.rm = TRUE),digits = 2)) %>%
  arrange(desc(delay)) %>%
  mutate(region = abbr2state(Origin_state))

delay_state <- delay_state %>%
  mutate(region = tolower(region)) %>%
  select(c('region','delay')) %>%
  unique()
  

total <- merge(all_states, delay_state, y.by="region")
total$region <- factor(total$region)
total <- total[order(total$order),]
```

```{r, fig.height=4}
plot5 <- ggplot(total, aes(long, lat, group=group, fill = delay)) +
  geom_polygon()+
  scale_fill_continuous(
  low = "#ffffff",high = "#a51626",
  guide= guide_colorbar(barwidth = 2,barheight = 10))+
  xlab("Longitude")+
  ylab("Latitude")
plot5
```
* Graph6: airport
```{r}
df61 <- df[,c("DepDelay","Origin")] %>%
  na.omit() %>%
  group_by(Origin) %>%
  mutate(avg_delay = mean(DepDelay)) %>%
  select("Origin","avg_delay") %>%
  unique() %>%
  arrange(desc(avg_delay))

df61_2 <- df61 %>%
  arrange(avg_delay)

org_head10 <- df61[1:10,]
org_tail10 <- df61_2[1:10,]

org <- rbind(org_head10, org_tail10)
org["judge"] = org$avg_delay > 0

df62 <- df[,c("DepDelay","Dest")] %>%
  na.omit() %>%
  group_by(Dest) %>%
  mutate(avg_delay = mean(DepDelay)) %>%
  select("Dest","avg_delay") %>%
  unique() %>%
  arrange(desc(avg_delay))

df62_2 <- df62 %>%
  arrange(avg_delay)

des_head10 <- df62[1:10,]
des_tail10 <- df62_2[1:10,]

des <- rbind(des_head10, des_tail10)
des["judge"] = des$avg_delay > 0
```

```{r, fig.height=5}
plot61 <- ggplot(org, aes(x = reorder(Origin, -avg_delay), y = avg_delay, fill = judge))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values = c("#92c0df","#fcbe75"))+
  theme(legend.position = "None")+
  ylab("Average Delay (mins)")+
  xlab("Origin Airport")

plot62 <- ggplot(des, aes(x = reorder(Dest, -avg_delay), y = avg_delay, fill = judge))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values = c("#92c0df","#fcbe75"))+
  theme(legend.position = "None")+
  ylab("Average Delay (mins)")+
  xlab("Destination Airport")

ggarrange(plot61,plot62,ncol = 1,nrow = 2)
```

* Graph7
```{r, include=FALSE}
df71 <- df %>%
  filter(UniqueCarrier == "WN"|UniqueCarrier == "CO"|UniqueCarrier == "F9"|UniqueCarrier == "AA"|UniqueCarrier == "UA"|UniqueCarrier == "EV"|UniqueCarrier == "MQ"|UniqueCarrier == "XE"|UniqueCarrier == "FL"|UniqueCarrier == "AS") %>%
  select(c('UniqueCarrier','DepHour','DepDelay'))

df71 <- df71 %>%
  mutate(DelayOrNot = case_when(
    DepDelay > 0 ~ 1,
    DepDelay <= 0 ~ 0
  ))

df71 <- df71 %>%
  group_by(UniqueCarrier, DepHour) %>%
  mutate(total_flight_hour = n(), total_delay_hour = sum(DelayOrNot)) %>%
  mutate(pct_delay = total_delay_hour/total_flight_hour)

df72 <- df71 %>%
  select(c(UniqueCarrier,DepHour,pct_delay)) %>%
  unique() %>%
  arrange(UniqueCarrier,DepHour)%>%
  na.omit()
```

```{r}
df73 <- df %>%
  filter(UniqueCarrier == "WN"|UniqueCarrier == "CO"|UniqueCarrier == "F9"|UniqueCarrier == "AA"|UniqueCarrier == "UA") %>%
  select(c('UniqueCarrier',"DayOfWeek",'DepHour','DepDelay'))

df73 <- df73 %>%
  mutate(DelayOrNot = case_when(
    DepDelay > 0 ~ 1,
    DepDelay <= 0 ~ 0
  ))

df73 <- df73 %>%
  group_by(UniqueCarrier,DayOfWeek,DepHour) %>%
  mutate(total_flight_hour = n(), total_delay_hour = sum(DelayOrNot)) %>%
  mutate(pct_delay = total_delay_hour/total_flight_hour)

df74 <- df73 %>%
  select(c(UniqueCarrier,DayOfWeek,DepHour,pct_delay)) %>%
  unique() %>%
  arrange(UniqueCarrier,DayOfWeek,DepHour)%>%
  na.omit()
```

```{r}
ggplot(data = df72 ) +
  geom_tile(aes(x = DepHour, y = UniqueCarrier, fill = pct_delay), color = 'black') +
  scale_x_continuous(breaks = c(5,11,17,22), labels = function(x){
    case_when(x == 5 ~ '5am', x == 11 ~ '11am', x == 17 ~ '5pm', x == 22 ~ '10pm')
  }) + coord_equal()+
  scale_fill_distiller(palette = 'Spectral') +
  labs(x = 'Hour of day', y = 'Airline', fill = 'Percentage',
       title = 'Percentage of delayed flights by hour of the day') +
  theme(panel.grid.major = element_blank(), axis.ticks = element_blank(),
        plot.caption = element_text(vjust = 7), axis.title.y = element_blank())

```

```{r,include=FALSE}
#test
test <- df[,c("UniqueCarrier","DepHour","DepDelay")]
test <- na.omit(test)
sum(test[test$UniqueCarrier == "AA" & test$DepHour == 2,]$DepDelay > 0)/nrow(test[test$UniqueCarrier == "AA" & test$DepHour == 2,])
```
```{r, fig.height=3}
ggplot(data = df74) +
  geom_line(aes(x = DepHour, y = pct_delay, color = UniqueCarrier), size = 0.5) +
  geom_point(aes(x = DepHour, y = pct_delay, color = UniqueCarrier), size = 0.7) +
  facet_grid(~DayOfWeek) +
  scale_x_continuous(limits = c(0,24), breaks = 8*c(0:3), labels = function(x){
    case_when(x == 0 ~ '', x == 8 ~ '8am', x == 16 ~ '4pm', x == 24 ~ '12am')
    }) +
  labs(x = 'Time', y = 'Percentage of delayed flights', color = 'Airline',
       title = 'x',
       subtitle = 'Top US airlines', caption = 'Source: publicly available data from DoT') +
  theme(plot.caption = element_text(vjust = 7)) +
  guides(fill = guide_legend(title = NULL))
```


* graph9
```{r, include=FALSE}
df91 <- df %>%
  select(c('Distance', 'DepDelay',"ActualElapsedTime","CRSElapsedTime","AirTime","ArrDelay","DepHour","DayofMonth","DayOfWeek")) %>%
  na.omit()
split = sample(x = 1:nrow(df91), size = 0.00001*nrow(df91))
small_dist = df91[split,]
```

```{r}
lowerFn <- function(data, mapping, ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(color = 'blue', alpha=0.3, size=0.5) +
    geom_smooth(color = 'black', method='lm', size=0.5,...)
  p
}

g <- ggpairs( 
  data = small_dist,
  lower = list(
    continuous =  wrap(lowerFn) #wrap("smooth", alpha = 0.3, color = "blue", lwd=1) 
  ),
  upper = list(continuous = wrap("cor", size = 3))
)
g <- g + theme(
  axis.text = element_text(size = 2),
  axis.title = element_text(size = 2),
  legend.background = element_rect(fill = "white"),
  panel.grid.major = element_line(colour = NA),
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "grey95")
)
print(g, bottomHeightProportion = 0.5, leftWidthProportion = .5)
```

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component
<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v5.js"></script>

<h3 class='text-left'>
            The Airline Performance by Each Delay Reason In 2008
          </h3>
          <p>
            Nowadays, flight delays is a tricky problem for travelers. Each time when the travelers meet a delay situation, they are curious about the main reason that caused the flight delay. This interactive bar plot below shows the average delay time and the number of delays by each flight delay reason. Please feel free to click the two bottons below to see the results you want! 
            <br>
          </p>

<button onclick="update(data1)">Average Delay(mins)</button>
<button onclick="update(data2)"># of Delay(count*1000)</button>

<div id="my_dataviz"></div>


<script>

var data1 = [
   {group: "LateAircraft", value: 20.97670989},
   {group: "NAS", value: 16.1584616},
   {group: "Carrier", value: 15.7529572},
   {group: "Weather", value: 2.93824316},
   {group: "Security", value: 0.08045906}
];

var data2 = [
   {group: "LateAircraft", value: 27.2085},
   {group: "NAS", value: 27.5652},
   {group: "Carrier", value: 25.8289},
   {group: "Weather", value: 3.7599},
   {group: "Security", value: 0.2746}
];

var margin = {top: 30, right: 30, bottom: 70, left: 60},
    width = 460 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

var x = d3.scaleBand()
  .range([ 0, width ])
  .domain(data1.map(function(d) { return d.group; }))
  .padding(0.2);
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))

var y = d3.scaleLinear()
  .domain([0, 30])
  .range([ height, 0]);
svg.append("g")
  .attr("class", "myYaxis")
  .call(d3.axisLeft(y));

function update(data) {

  var u = svg.selectAll("rect")
    .data(data)

  u
    .enter()
    .append("rect")
    .merge(u)
    .transition()
    .duration(1000)
      .attr("x", function(d) { return x(d.group); })
      .attr("y", function(d) { return y(d.value); })
      .attr("width", x.bandwidth())
      .attr("height", function(d) { return height - y(d.value); })
      .attr("fill", "steelblue")
}

update(data1)

</script>

<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

